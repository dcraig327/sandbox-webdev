# Общение окон с разных доменов: postMessage 

Интерфейс `postMessage` позволяет общаться друг с другом окнам и ифреймам с разных доменов.

Он очень удобен, например, для взаимодействия внешних виджетов и сервисов, подключённых через ифрейм с основной страницей.
[cut]

## Интерфейс

Интерфейс состоит из двух частей.

### Отправитель: метод postMessage

Первая часть состоит из метода [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window.postMessage). Его вызывает окно, которое хочет отправить сообщение, в контексте окна-получателя.

Проще говоря, если мы хотим отправить сообщение в окно `win`, то нужно вызвать `win.postMessage(data, targetOrigin)`.

Аргументы:

<dl>
<dt>data</dt>
<dd>Данные. По спецификации, это может быть любой объект, который будет *клонирован с сохранением структуры* при передаче. 

Но IE поддерживает только строки, поэтому обычно данные JSON-сериализуют.</dd>
<dt>targetOrigin</dt>
<dd>Разрешить получение сообщения только окнам с данного источника. 

Мы ведь не можем из JavaScript узнать, на каком именно URL находится другое окно. Но иногда хочется быть уверенным, что данные передаются в доверенный документ. Для этого и нужен этот параметр. Проверку осуществляет браузер. При указании `'*'` ограничений нет.</dd>
</dl>

[warn header="В IE8 можно использовать `postMessage` только для ифреймов"]

В браузере IE8, интерфейс `postMessage` работает только с ифреймами. Он не работает между табами и окнами. 

Это ошибка в данном конкретном браузере, в других -- всё в порядке.
[/warn]

### Получатель: событие onmessage

Чтобы получить сообщение, окно должно поставить обработчик на событие `onmessage`.

Свойства объекта события:
<dl>
<dt>`data`</dt>
<dd>Присланные данные</dd>
<dt>`origin`</dt>
<dd>Источник, из которого пришло сообщение, например `http://javascript.ru`.</dd>
<dt>`source`</dt>
<dd>Ссылка на окно, с которого пришло сообщение. Можно тут же ответить.</dd>
</dl>

Назначать обработчик нужно обязательно через методы `addEventListener/attachEvent`, например:

```js
function listener(event) {
  if( event.origin != 'http://learn.javascript.ru') { 
    // что-то прислали с чужого домена - проигнорируем..    
    return;
  }

  document.getElementById("msg").innerHTML = "получено: " + event.data;
}

if (window.addEventListener){
  window.addEventListener("message", listener, false);
} else {
  window.attachEvent("onmessage", listener);
}
```

Этот код содержит ифрейм ниже, с именем `name="receiveFrame"`:

<iframe src="/files/tutorial/window/receive.html" style="width:100%; height: 60px; border:1px solid black" frameborder="0" name="receiveFrame"></iframe>

Запустите код для отправки ему сообщения:

```js
//+ run
var win = frames.receiveFrame;
win.postMessage("Привет!", "http://learn.javascript.ru");
```

## Задержка

Задержки между отправкой и получением нет, совсем.

Если для `setTimeout` стандарт предусматривает минимальную задержку 4мс, то для `postMessage` она равна 0мс.  

Поэтому `postMessage` можно, в том числе, использовать как мгновенную альтернативу `setTimeout`.

## Итого

Интерфейс `postMessage` позволяет общаться окнам и ифреймам с разных доменов (в IE8 -- только ифреймы), при этом обеспечивая проверки безопасности.

<ol>
<li>Отправитель вызывает `targetWin.postMessage(data, targetOrigin)`.</li>
<li>Если `targetOrigin` не `'*'`, то браузер проверяет, совпадает ли источник с `targetWin`.</li>
<li>Если совпадает, то на `targetWin` генерируется событие `onmessage`, в котором передаются:
<ul>
<li>`origin` -- источник, с которого пришло сообщение.</li>
<li>`source` -- ссылка на окно-отправитель.</li>
<li>`data` -- данные. Везде, кроме IE, допустимы объекты, которые клонируются, а в IE -- только строка.</li>
</ul>
</li>
<li>Обработчик на `onmessage` необходимо вешать при помощи специализированных методов `addEventListener/attachEvent`.</li>
</ol>
