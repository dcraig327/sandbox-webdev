# Атака Clickjacking и защита от неё

Атака "кликджекинг" (англ. Clickjacking) позволяет хакеру выполнить клик на сайте-жертве *от имени посетителя*. 

В русском языке встречается дословный перевод термина clickjacking: "угон клика". Так же применительно к clickjacking-атаке можно встретить термины "перекрытие iframe" и "подмена пользовательского интерфейса".

Кликджекингу подверглись в своё время Twitter, Facebook , PayPal, YouTube и многие другие сайты. Сейчас, конечно, они уже защищены.
[cut]
## Идея атаки

В целом идея очень проста.

Вот как выглядит «угон клика» пользователя, который зарегистрирован на  facebook:

<ol>
<li>На вредоносной странице пользователю подсовывается безобидная ссылка
(скажем, что-то скачать, «разбогатеть сейчас», посмотреть ролик или просто перейти по ссылке на интересный ресурс).</li>
<li>Поверх этой заманчивой ссылки помещен прозрачный iframe со страницей facebook.com, так что кнопка "Like" находится чётко над ней.

Кликая на ссылку, посетитель на самом деле нажимает на эту кнопку.
</li>
</ol>

## Пример

Вот пример (для наглядности `iframe` -- полупрозрачный):

```html
<!--+ run height=120 -->
<style>
iframe { /* iframe с сайта-жертвы */
  width: 300px;
  height: 100px;
  position: absolute;
  top:0; left:-20px;
  filter: alpha(opacity=50); /* в рельности будет opacity=50 */
  opacity: 0.5;
  z-index: 1;
}
</style>
 
<div>Нажмите, чтобы разбогатеть сейчас:</div>
     
<!-- URL в реальности - с другого домена (атакуемого сайта) -->
<iframe src="http://js.cx/clickjacking/facebook.html"></iframe>
 
<a href="http://google.com">Нажми тут!</a>
 
<div>..И всё получится (хе-хе, у меня, злого хакера, получится)!</div>
```

**При клике на ссылку на самом деле происходит клик на iframe (на «Like»).**

Если посетитель авторизован на facebook (а в большинстве случаев так и есть), то facebook.com получает щелчок от имени посетителя.

На Twitter это была бы кнопка «Follow».

Тот же самый код, но как это было бы в реальности, с `opacity:0` для iframe (щелкните, чтобы увидеть захваченную кнопку):

[iframe src="clickjacking" height=120 link edit]

Итак, все, что нужно для проведения атаки --  это правильно расположить iframe на  вредоносной странице. В большинстве случаев это делается средствами HTML/CSS.

События клавиатуры захватить гораздо труднее, потому что, если `iframe` является невидимым, то текст в поле ввода также будет невидимым. Посетитель начнёт печатать, но, не увидев текст, прекратит свои действия.

## Защита и способы обхода.

Самый старый метод защиты -- это код JavaScript, не позволяющий отобразить веб-страницу внутри фрейма (*framebusting*, также его называют *framekilling* и *framebreaking*). 

Добавьте к документу следующий код, если не хотите, чтобы документ загружался в iframe:

<script>
if (top != window) {
  top.location = window.location;
}
</script>

То есть, если окно обнаруживает, что оно загружено во фрейме, то оно автоматически делает себя верхним.

В настоящий момент это уже не является сколько-нибудь надежной защитой. 

Есть несколько способов обхода framebusting. Давайте рассмотрим некоторые из них.

### Блокировка top-навигации.

Можно заблокировать переход, инициированный сменой `top.location`, в событии [onbeforeunload](#window.onbeforeunload).

Обработчик этого события ставится на внешней (хакерской) странице и, при попытке  `iframe` поменять `top.location`, спросит посетителя, хочет он покинуть данную страницу. В большинстве браузеров хакер может спросить посетителя, используя своё сообщение.

Так что, скорее всего, посетитель ответит на такой странный вопрос отрицательно (он же не знает про ифрейм, видит только страницу, причины для ухода нет).

В приведенном ниже примере представлен "защищенный" `iframe`:

```html
<!--+ src="cj_location.html" play -->
```

А вот -- хакерская страница с этим `iframe`, которая отменяет перезагрузку верхнего окна при помощи `onbeforeunload` (предполагается, что посетитель нажмёт «отмену»):

```html
<script>
window.onbeforeunload = function() {
  window.onbeforeunload = null;
  return "Хотите уйти с этой страницы, не узнав все её тайны (хе-хе)?";
}
</script>
 
<iframe src="/files/tutorial/window/cj_location.html" style="height:80px"></iframe>
```

[Открыть в отдельном окне (сразу спросит)](/files/tutorial/window/cj_location_hack.html).

### security = "restricted"

В IE8 есть особый атрибут `security = "restricted"` -- отключающий исполнение скриптов во фрейме.

Пример использования:

```html
<iframe security="restricted" src="/files/tutorial/window/cj_location.html" style="height:80px"></iframe>
```

При этом клик во фрейме, если он не требует JavaScript, всё равно сработает, а вот защита -- нет.

### HTML5

Одна из возможностей HTML5 -- атрибут [sandbox](http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#attr-iframe-sandbox)

Он позволяет разрешить во фрейме скрипты `allow-scripts` и формы `allow-forms`, но запретить top-навигацию (не указать `allow-top-navigation`).

Выглядеть это будет так:

```html
<iframe *!*sandbox="allow-scripts allow-forms"*/!* src="/files/tutorial/window/cj_location.html"></iframe>
```

Сработает в браузерах, которые поддерживают `sandbox`, например -- в Chrome.

### Ещё приёмы

Есть и еще приёмы для обхода этой простейшей защиты. 

Firefox и старый IE могут активировать designMode на исходной странице, это также предотвращает framebusting (спасибо за идею owasp.org, страница clickjacking).

Как мы видим, она не только не выдерживает реальной атаки, но и может скомпрометировать сайт (программист-то думает, что защитил его).

## Надежная защита от Clickjacking

### Заголовок X-Frame-Options

Все современные браузеры поддерживают заголовок `X-Frame-Options`.

Он разрешает или запрещает отображение страницы, если она открыта во фрейме.

Браузеры игнорируют заголовок, если он определен в МЕТА тег. Таким образом, `<meta http-equiv="X-Frame-Options"...>` будет проигнорирован.

У заголовка может быть три значения:

<dl>
<dt>SAMEORIGIN</dt>
<dd>Рендеринг документа, при открытии во фрейме, производится только в том случае, когда верхний (top) документ -- с того же домена.</dd>
<dt>DENY</dt>
<dd>Рендеринг документа внутри фрейма запрещён.</dd>
<dt>ALLOW-FROM domain</dt>
<dd>Разрешает рендеринг, если внешний документ с данного домена (не поддерживается в Safari, Firefox).</dd>
</dl>

К примеру, Twitter использует `X-Frame-Options: SAMEORIGIN`. Результат:

```html
<iframe src="http://twitter.com"></iframe>
```

<iframe src="http://twitter.com"></iframe>

В зависимости от браузера, `iframe` выше либо пустой, либо в нём находится сообщение о невозможности отобразить его (IE).

### Приостановка показа документа

Если нужно поддерживать старые браузеры (IE<8), то можно и просто отменить показ документа:

```html
<head>
  <style> body { display : none } </style>
</head>
<body>
 
<script>
  if (self == top) {
    document.getElementsByTagName('body').style.display = "block";
  } else {
    top.location = self.location;
  }
</script>
```

[warn header="Почему не `document.body`?"]
В приведенном выше примере, мы используем `document.getElementsByTagName`, вместо `document.body`, потому что это способ получения `BODY` работает во всех браузерах, когда документ еще не готов.
[/warn]

Обратите внимание -- изначально документ скрыт. Мало ли, вдруг JavaScript во фрейме отключен -- защита сработает.

Он будет показан только в том случае, если заведомо всё в порядке: не отключён JavaScript и страница не во фрейме.

### Показ с отключённым функционалом

Заголовок `X-Frame-Options` имеет неприятный побочный эффект. Иногда поисковики, анонимайзеры или другие сайты хотели бы отобразить страницу в `iframe`, по вполне "легальным" причинам, но не могут.

Хорошо бы показывать их посетителям не пустой `iframe`, а нечто, что может быть более интересно.

Например, можно изначально "накрывать" документ `div` с `height:100%;width:100%`, который будет перехватывать все клики. И поставить на нём ссылку, ведующую на страницу в новом окне.

```html
<style>
  #iframe-protector {
    height: 100%; 
    width: 100%; 
    position: absolute; 
    left: 0; 
    top: 0;
    z-index: 99999999;
  }
</style>

<div id="iframe-protector">
  <a href="/" target="_blank">Перейти на сайт</a>
</div>

<script>
  if (top.document.domain == document.domain) {
    убрать iframe-protector
  }
</script>
```

Если страница -- не во фрейме или домен совпадает, то посетитель не увидит его.

## Заключение

Атаку "Clickjacking" легко осуществить, если на сайте есть действие, активируемое с помощью одного клика.

Злоумышленник может осуществить атаку через целенаправленно на посетителей ресурса -- опубликовав ссылку на форуме, или «счастливой рассылкой». Существует масса вариантов.

<ul>
<li>Рекомендуется использовать X-Frame-Options на страницах, заведомо не предназначеных для запуска во фрейме и на важнейших страницах (финансовые транзакции).</li>
<li>Используйте защиту через framebusting для защиты IE<8, т.к. там не поддерживается X-Frame-Options.</li>
<li>Используйте перекрывающий DIV, если это допустимо вашим проектом и вы хотите разрешить безопасный показ документа во фреймах с любых доменов.</li>
</ul>

<div style="text-align:right; font-style:italic">При участии Марата Шагиева</div>