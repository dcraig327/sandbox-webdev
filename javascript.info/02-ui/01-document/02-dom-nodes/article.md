# Дерево DOM

Основным инструментом работы и динамических изменений на странице является DOM (Document Object Model) -- объектная модель, используемая для XML/HTML-документов.


[cut]
Согласно DOM-модели, документ является иерархией, деревом. Каждый HTML-тег образует узел дерева с типом "элемент". Вложенные в него теги становятся дочерними узлами. Для представления текста создаются узлы с типом "текст".

**DOM -- это представление документа в виде дерева объектов, доступное для изменения через JavaScript.**

## Пример DOM

Построим, для начала, дерево DOM для следующего документа.

```html
<!--+ run -->
<!DOCTYPE HTML>
<html>
  <head>
    <title>О лосях</title>
  </head>
  <body>
     Правда о лосях
   </body>
</html>
```

<div class="domtree"></div>
<script>
var node = {"name":"HTML","nodeType":1,"children":[{"name":"HEAD","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"\n    "},{"name":"TITLE","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"О лосях"}]},{"name":"#text","nodeType":3,"content":"\n  "}]},{"name":"#text","nodeType":3,"content":"\n  "},{"name":"BODY","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"\n     Правда о лосях\n   \n\n"}]}]}

drawHtmlTree(node, [].pop.call(document.querySelectorAll('div.domtree')), 690, 350);
</script>

В этом дереве выделено два типа узлов.

<ol>
<li><span style="color:#5e8aae">Теги образуют синие узлы-элементы (element node).</span> Естественным образом одни узлы вложены в другие. Структура дерева образована за счет синих элементов-узлов -- тегов HTML.</li>
<li><span style="color:#ab9347">Текст внутри элементов образует **текстовые узлы** (text node),</span> обозначенные как `#text`. Текстовый узел содержит исключительно строку текста и не может иметь потомков.</li>
</ol>

Например, у корневого элемента `<html>` есть три узла-потомка: `<head>`, текстовый узел и `<body>`

**На рисунке выше синие узлы-элементы можно кликать, при этом их дети будут скрываться-раскрываться.**

Обратите внимание на специальные символы в текстовых узлах:
<ul>
<li>перевод строки: `↵`</li>
<li>пробел: `␣`</li>
</ul>

**Пробелы и переводы строки -- это тоже текст, полноправные символы, которые учитываются в DOM!**

В частности, в примере выше тег `<head>` содержит не только узел-элемент `<title>`, но и два текстовых узла до и после него, состоящие из пробелов и переводов строк. Они не видны, но они существуют!

Исключения из этого правила только на самом верхнем уровне -- пробелы до `<head>` по стандарту игнорируются, а любое содержимое после `</body>` не создаёт узла, браузер переносит его в конец `body`.

В остальных случаях всё честно -- если пробелы есть в документе, то они есть и в DOM, а если их убрать, то и в DOM их не будет, получится так:

```html
<!DOCTYPE HTML>
<html><head><title>О лосях</title></head><body>Правда о лосях</body></html>
```

<div class="domtree"></div>
<script>
var node = {"name":"HTML","nodeType":1,"children":[{"name":"HEAD","nodeType":1,"children":[{"name":"TITLE","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"О лосях"}]}]},{"name":"BODY","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"Правда о лосях\n"}]}]}

drawHtmlTree(node,  [].pop.call(document.querySelectorAll('div.domtree')), 690, 300);
</script>

## Автоисправление

**При чтении неверного HTML браузер автоматически корректирует его для показа и при построении DOM.**

В частности, всегда будет верхний тег `<html>`. Даже если в тексте нет -- в DOM он будет, браузер создаст его самостоятельно. 

То же самое касается и тега `<body>`. 

Например, если файл состоит из одного слова `"Привет"`, то браузер автоматически обернёт его в `<html>` и `<body>`. 

**При генерации DOM браузер самостоятельно обрабатывает ошибки в документе, закрывает теги и так далее.**

Такой документ:

```html
<p>Привет
<li>Мама
<li>и
<li>Папа
```

...Превратится вот во вполне респектабельный DOM, браузер сам закроет теги:

<div class="domtree"></div>
<script>
var node = {"name":"HTML","nodeType":1,"children":[{"name":"HEAD","nodeType":1,"children":[]},{"name":"BODY","nodeType":1,"children":[{"name":"P","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"Привет\n"}]},{"name":"LI","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"Мама\n"}]},{"name":"LI","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"и\n"}]},{"name":"LI","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"Папа\n"}]}]}]}

drawHtmlTree(node,  [].pop.call(document.querySelectorAll('div.domtree')), 690, 400);
</script>

[warn header="Таблицы всегда содержат `<tbody>`"]
Важный "особый случай" при работе с DOM -- таблицы. По стандарту DOM они обязаны иметь `<tbody>`, однако по стандарту HTML их можно написать без него.

В этом случае браузер добавляет `<tbody>` самостоятельно.

Например, для такого HTML:

```html
<table id="table">
  <tr><td>1</td></tr>
</table>
```

DOM-структура будет такой:
<div class="domtree"></div>
<script>
var node = {"name":"TABLE","nodeType":1,"children":[{"name":"TBODY","nodeType":1,"children":[{"name":"TR","nodeType":1,"children":[{"name":"TD","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"1"}]},{"name":"#text","nodeType":3,"content":"\n"}]}]}]};

drawHtmlTree(node,  [].pop.call(document.querySelectorAll('div.domtree')), 600, 200);
</script>

Вы видите? Появился `<tbody>`, как будто документ был таким:

```html
<table>
*!*
  <tbody>
*/!*
    <tr><td>1</td></tr>
*!*
  </tbody>
*/!*
</table>
```

Важно знать об этом, иначе при работе с таблицами возможны сюрпризы.
[/warn]


## Другие типы узлов

Дополним страницу новыми тегами и комментарием:

```html
<!DOCTYPE HTML>
<html>
  <body>
    Правда о лосях
    <ol>
      <li>Лось — животное хитрое</li>
*!*
      <!-- комментарий -->
*/!*
      <li>..и коварное!</li>
    </ol>
  </body>
</html>
```

<div class="domtree"></div>
<script>
var node = {"name":"HTML","nodeType":1,"children":[{"name":"HEAD","nodeType":1,"children":[]},{"name":"BODY","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"\n    Правда о лосях\n    "},{"name":"OL","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"\n      "},{"name":"LI","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"Лось — животное хитрое"}]},{"name":"#text","nodeType":3,"content":"\n      "},{"name":"#comment","nodeType":8,"content":" комментарий "},{"name":"#text","nodeType":3,"content":"\n      "},{"name":"LI","nodeType":1,"children":[{"name":"#text","nodeType":3,"content":"..И коварное!"}]},{"name":"#text","nodeType":3,"content":"\n    "}]},{"name":"#text","nodeType":3,"content":"\n  \n\n"}]}]};

drawHtmlTree(node,  [].pop.call(document.querySelectorAll('div.domtree')), 690, 550);
</script>

**В этом примере тегов уже больше, и даже появился узел нового типа -- *комментарий*.**

Казалось бы, зачем комментарий в DOM? На отображение-то он всё равно не влияет. Но так как он есть в HTML -- обязан присутствовать в DOM-дереве.

**Всё, что есть в HTML, находится и в DOM.** 

Вообще-то это секрет, но и директива `<!DOCTYPE...>` тоже является DOM-узлом, и находится в дереве DOM непосредственно перед HTML. На иллюстрациях выше этот факт скрыт, поскольку здесь и далее мы с этим узлом работать не будем. 

Даже сам объект `document`, формально, является DOM-узлом, самым-самым корневым.

Всего различают 12 типов узлов, но на практике мы работаем с тремя из них: элемент, текст и, редко, комментарии (если они есть в HTML).

## Возможности, которые дает DOM

Зачем, кроме красивых рисунков, нужна иерархическая модель DOM? 

**DOM нужен для того, чтобы манипулировать страницей -- читать информацию из HTML, создавать и изменять элементы.** 

Узел `HTML`  можно получить как `document.documentElement`, а `BODY` -- как `document.body`. Получив узел, мы можем что-то сделать с ним.

Например, можно поменять цвет `BODY` и вернуть обратно:

```js
//+ run
document.body.style.backgroundColor = 'red';
alert('Поменяли цвет BODY');

document.body.style.backgroundColor = '';
alert('Сбросили цвет BODY');
```

Фактически, DOM предоставляет возможность делать со страницей всё, что угодно, и далее мы этому научимся.

## Особенности IE8-

**IE8- не генерирует текстовые узлы, если они состоят только из пробелов.**

 То есть, такие два документа дадут идентичный DOM:

```html
<!DOCTYPE HTML>
<html><head><title>О лосях</title></head><body>Правда о лосях</body></html>
```

И такой:

```html
<!DOCTYPE HTML>
<html>
  <head>
    <title>О лосях</title>
  </head>
  <body>
    Правда о лосях
  </body>
</html>
```

Эта, с позволения сказать, "оптимизация" не соответствует стандарту и IE9+ уже работает как нужно, то есть как описано ранее.

Но, по большому счёту, для нас должно быть без разницы, старый или новый IE.

**При работе с DOM/HTML мы в любом случае не должны быть завязаны на то, есть пробел между тегами или его нет. Мало ли, сегодня он есть, а завтра решили переформатировать HTML и его не стало.**

К счастью, свойства и методы DOM, которые мы пройдём далее, вполне позволяют писать код, который будет работать корректно во всех версиях браузеров.

## Итого

<ul>
<li>DOM-модель -- это внутреннее представление HTML-страницы в виде дерева.</li>
<li>Все элементы страницы, включая теги, текст, комментарии, являются узлами DOM.</li>
<li>У элементов DOM есть свойства и методы, которые позволяют изменять их.</li>
<li>IE8- не генерирует пробельные узлы.</li>
</ul>

Кстати, DOM-модель используется не только в JavaScript, это известный способ представления XML-документов.

В следующих главах мы лучше познакомимся с DOM и увидим, какие свойства и методы нужны, чтобы творить красивые штуки со страницей.

[libs]
d3
domtree
[/libs]