# Открытие новых окон

Всплывающее окно ("попап" -- от англ. Popup window) -- один из старейших способов показать пользователю ещё один документ.

В этой статье мы рассмотрим открытие окон и ряд тонких моментов, которые с этим связаны.

[cut]

Простейший пример:

```js
//+ run
window.open("http://ya.ru");
```

...При запуске откроется новое окно с данным URL.

Большинство браузеров по умолчанию создают новую вкладку вместо отдельного окна, но чуть далее мы увидим, что можно и "заказать" именно окно.

## Блокировщик всплывающих окон

Рекламные попапы очень надоели посетителям, аж со времён 20го века, поэтому современные браузеры всплывающие окна обычно блокируют. При этом пользователь, конечно, может изменить настройки блокирования для конкретного сайта.

**Всплывающее окно блокируется в том случае, если вызов `window.open` произошёл не в результате действия посетителя.**

Как же браузер понимает -- посетитель вызвал открытие окна или нет?

**Для этого при работе скрипта он хранит внутренний "флаг", который говорит -- инициировал посетитель выполнение или нет.** 

Например, при клике на кнопку весь код, который выполнится в результате, включая вложенные вызовы, будет иметь флаг "инициировано посетителем" и попапы при этом разрешены.

А если код был на странице и выполнился автоматически при её загрузке -- у него этого флага не будет. Попапы будут заблокированы..

Здесь есть ещё ряд тонких моментов. Например: обработчик `onclick` вызвал `setTimeout(func, timeout)`. В результате код `func` выполнится уже после того, как событие `onclick` обработано. Следует ли передать ему флаг "инициировано посетителем" или нет? 

Возможны разные точки зрения, например, IE блокирует такие окна (видимо, проще было реализовать), а Firefox и Chrome/Safari передают флаг, если таймаут меньше секунды. А если больше -- то не передают ;)

Вот это окно откроется в Firefox и Chrome (но не в IE):

```js
//+ run
setTimeout(function() { 
  window.open("http://ya.ru");
}, *!*500*/!*);
```

...А это -- будет заблокировано:

```js
//+ run
setTimeout(function() { 
  window.open("http://ya.ru");
}, *!*2500*/!*);
```

**Таким образом, современные браузеры расширяют область "действий посетителя" и блокируют попапы не всегда.**

## Синтаксис window.open

Полный синтаксис:

```js
win = window.open(url, name, params)
```

<dl>
<dt>`url`</dt>
<dd>URL для загрузки в новое окно.</dd>
<dt>`name`</dt>
<dd>Имя нового окна. Может быть использовано в параметре `target` в формах. Если позднее вызвать `window.open()` с тем же именем, то некоторые браузеры (Firefox) заменяют существующее окно на новосозданное. А вот IE при этом откроет новое окно.</dd>
<dt>`params`</dt>
<dd>Строка с конфигурацией для нового окна. Состоит из параметров, перечисленных через запятую. Пробелов в ней быть не должно.</dd>
</dl>

**Можно легко узнать, было ли окно заблокировано. При этом результат `window.open` равен `null`.**

Значения параметров `params`.

<ol>
<li>Настройки расположения окна:

<dl>
<dt>`left/top` (число)</dt>
<dd>Координаты верхнего левого угла относительно экрана. Ограничение: новое окно не может быть позиционированно за пределами экрана.</dd>
<dt>`width/height` (число)</dt>
<dd>Ширина/высота нового окна. Минимальные значения ограничены, так что невозможно создать невидимое окно с нулевыми размерами.</dd>
</dl>

Если координаты и размеры не указаны, то обычно браузер открывает не окно, а новую вкладку.

</li>
<li>Свойства окна:
<dl>
<dt>`menubar` (yes/no)</dt>
<dd>Скрыть или показать строку меню браузера.</dd>
<dt>`toolbar` (yes/no)</dt>
<dd>Показать или скрыть панель навигации браузера (кнопки назад, вперед, обновить страницу и остальные) в новом окне.</dd>
<dt>`location` (yes/no)</dt>
<dd>Показать/скрыть поле URL-адреса в новом окне. По умолчанию Firefox и IE не позволяют скрывать строку адреса.</dd>
<dt>`status` (yes/no)</dt>
<dd>Показать или скрыть строку состояния. С другой стороны, браузер может в принудительном порядке показать строку состояния.</dd>
<dt>`resizable` (yes/no)</dt>
<dd>Позволяет отключить возможность изменять размеры нового окна. Значение `no` обычно неудобно посетителям.</dd>
<dt>`scrollbars` (yes/no)</dt>
<dd>Разрешает убрать полосы прокрутки для нового окна. Значение `no` обычно неудобно посетителям.</dd>
</dl>
</li>
<li>Еще есть небольшое количество не кросс-браузерных свойств, которые обычно не используются. Вы можете узнать о них в документации, например MDN: [window.open](https://developer.mozilla.org/en/DOM/window.open).</li>
</ol>

Откроем окно с минимальным набором функций, чтобы посмотреть, какие из них браузер позволяет отключить:

```js
//+ run
var params = 'scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no' +
 'width=0,height=0,left=-1000,top=-1000';
window.open('/', 'test', params);
```

Здесь большинство параметров отключено и окно позиционированно за пределами экрана. Запустите, чтобы увидеть, что произойдет на самом деле.

Теперь давайте добавим корректные параметры позиционирования: нормальную ширину, высоту и координаты левого верхнего угла.

Этот пример браузер отобразит "как заказано":

```js
//+ run
var params = 'scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no' +
 'width=100,height=100,left=100,top=100';
window.open('/', 'test', params);
```

Важные моменты:

<ul>
<li>Если при вызове `open` третий параметр отсутствует, то используются параметры по умолчанию. Обычно при этом будет открыто не окно, а вкладка.</li>
<li>Если указана строка с параметрами, но некоторые `yes/no` параметры отсутствуют, то браузер выставляет их в `no`. Поэтому убедитесь, что все нужные вам параметры выставлены в `yes`.</li>
<li>Когда не указан `top/left`, то браузер откроет окно с небольшим смещением относительно левого верхнего угла последнего открытого окна.</li>
<li>Если не указаны `width/height`, новое окно будет такого же размера, как последнее открытое.</li>
</ul>

## Доступ к новому окну

Вызов `window.open` возвращает ссылку на новое окно. Она может быть использована для манипуляции свойствами окна, изменения URL, доступа к его переменным и т.п.

В примере ниже содержимое нового окна модифицируется после загрузки.

```js
//+ run
var newWin = window.open('/', 'example', 'width=600,height=400');
newWin.focus();
newWin.onload = function() {

  // создать div в документе нового окна
  var div = *!*newWin*/!*.document.createElement('div');
  div.innerHTML = 'Добро пожаловать!'
  div.style.fontSize = '30px'

*!*
  var body = newWin.document.body;
*/!*
  // вставить первым элементом в новое body
  body.insertBefore(div, body.firstChild);
}
```

**Сразу после `window.open` новое окно ещё не загружено.**

Поэтому в примере выше изменения начинаются при `onload`. Можно использовать и событие `DOMContentLoaded`.

[warn header="Same Origin Policy -- защита проверкой протокол-сайт-порт"]
**Большинство действий, особенно получение содержимого окна и его переменных, возможны лишь в том случае, если URL нового окна происходит из того же источника (англ. - *"Same Origin"*), т.е. совпадают домен, протокол и порт.**

Иначе говоря, если новое окно содержит документ с того же сайта.

Исключение: замена адреса. Поменять (но не прочитать) `win.location = ...` можно всегда, даже если окно с другого домена.

Больше информации об этом -- в главе [](/same-origin-policy).
[/warn]

## Связь между новым и родительским окном

Связь между окнами -- двухсторонняя. Родительское окно получает ссылку из `window.open`, а дочернее -- специальное свойство `window.opener`.

Оно равно `null`, если открывшего окна нет.

## Итого

<ul>
<li>Всплывающее окно открывается с помощью вызова `window.open(url, name, params)`.</li>
<li>Метод `window.open` возвращает ссылку на новое окно или `null`, если окно было заблокировано.</li>
<li>Современные браузеры блокируют окна, если `window.open` вызвано не в результате действия посетителя.</li>
<li>Обычно открывается вкладка, но если заданы размеры и позиция -- то именно окно.</li>
<li>Новое окно имеет ссылку на родительское в `window.opener`.</li>
<li>Окна могут общаться между собой как угодно, если они из одного источника. Иначе действуют жёсткие ограничения безопасности.</li>
</ul>

Всплывающие окна используются нечасто. Ведь загрузить новую информацию можно динамически, с помощью технологии AJAX, а показать -- в элементе `DIV`, расположенным над страницей (`z-index`). Ещё одна альтернатива -- тег `IFRAME`.

Но в некоторых случаях всплывающие окна бывают очень даже полезны. Например, отдельное окно сервиса онлайн-консультаций. Посетитель может ходить по сайту в основном окне, а общаться в чате -- во вспомогательном.

Если вы хотите использовать всплывающее окно, предупредите посетителя об этом, так же и при использовании `target="_blank"` в ссылках или формах. Иконка открывающегося окошка на ссылке поможет посетителю понять, что происходит и не потерять оба окна из поля зрения.


<p style="text-align:right">Спасибо Марату Шагиеву за помощь в выкладке русскоязычного варианта этой главы.</p> 