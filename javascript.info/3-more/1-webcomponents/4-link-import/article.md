# Импорты

Новая спецификация ["HTML Imports"](http://w3c.github.io/webcomponents/spec/imports/index.html) описывает, как вставить один документ в другой при помощи HTML-тега `<link rel="import">`.

[cut]

## Зачем?

Мы ведь и так можем вставлять документ в документ, при помощи `<iframe>`, зачем нужен ещё какой-то импорт? Что не так с `iframe`?

...С `iframe` всё так. Однако, по своему смыслу `iframe` -- это отдельный документ.
<ul>
<li>Для `iframe` создаётся полностью своё окружение, у него свой объект `window` и свои переменные.</li>
<li>Если `iframe` загружен с другого домена, то взаимодействие с ним возможно только через `postMessage`.</li>
</ul>

Это хорошо, когда нужно действительно в одной странице отобразить содержимое другой.

А что, если нужно встроить другой документ как естественную часть текущего? С единым скриптовым пространством, едиными стилями. И желательно не иметь проблем с разными доменами: если уж мы действительно хотим подключить HTML с одного домена в  страницу на другом -- мы должны иметь возможность это сделать без "плясок с бубном".

Именно для этого предназначен `<link rel="import" href="...">`.

## Пример вставки

Синтаксис:

```html
<link rel="import" href="http://site.com/document.html">
```

<ul>
<li>В отличие от `<iframe>` тег `<link rel="import">` может быть в любом месте документа.</li>
<li>При вставке через `<iframe>` документ показывается внутри фрейма. В случае с `<link rel="import">` это не так, по умолчанию документ вообще не показывается.</li>
</ul>

**HTML, загруженный через `<link rel="import">` имеет отдельный DOM документа, но скрипты в нём выполняются в общем контексте страницы.**

Файл, загруженный через `<link rel="import">`, обрабатывается, выполняются скрипты, строится DOM документа, но не показывается, а записывается в свойство `link.import`. 

Мы сами решаем, где и когда его вставить.

Например:
[iframe src="import-show" link edit height="60" border="1"]

Основной документ:

```html
<!--+ src="index.html" -->
```

Важные детали:
<ul>
<li>Загрузка осуществляется асинхронно, для того чтобы поймать момент загрузки -- используется событие `onload`, для ошибки -- `onerror`.</li>
<li>Подгруженный документ доступен как `link.import`. Это полноценный HTML-документ.</li>
</ul>

Файл `timer.html`:

```html
<!--+ src="timer.html" -->
```

Важные детали:
<ul>
<li>После загрузки все скрипты в подключённом `timer.html` выполняются в контексте основной страницы, так что `timer` и другие переменные станут глобальными переменными страницы.</li>
<li>Переменная `document` -- это документ основной страницы. Для доступа к импортированному, то есть текущему документу его можно получить как `document.currentScript.ownerDocument`.</li>
<li>Таймер в загруженном документе начинает работать сразу, новый документ активен, хотя до переноса узлов в основной документ этого не видно.</li>
</ul>

В примере выше содержимым импорта управлял основной документ, но `timer.html` мог бы и показать сам себя вызовом `document.body.appendChild(timer)` или вызвать функцию с внешнего документа, так как у них единая область видимости. Тогда не понадобился бы никакой `onload`.

Ещё пример вставки:

[iframe src="import-style" link edit height="60" border="1"]

Основной документ:

```html
<!--+ src="index.html" -->
```

Сейчас он просто загружает `timer.html` и всё. А вставит себя импорт сам.

Файл `timer.html`:

```html
<!--+ src="timer.html" -->
```

**Обратим внимание -- стили импорта попадают в контекст страницы.**

В примере выше импорт добавил и стиль для `#timer` и сам элемент.

## Веб-компоненты

Импорт задуман как часть платформы веб-компонент.

Предполагается, что главный документ может импортировать файлы-определения, в которых будут все необходимые HTML, JS и CSS для элементов:

Файл `index.html`:

```html
<link rel="import" href="ui-tabs.html">
<link rel="import" href="ui-dialog.html">

<ui-tabs>...</ui-tabs>
<ui-dialog>...</ui-dialog>
```

В следующей главе мы разберём расширенный пример на эту тему.

## Повторное использование

Повторный импорт с тем же URL использует уже существующий документ.
 
Если файл `libs.html` импортирован два раза, то CSS и скрипты из него подключатся и выполнятся ровно один раз.

Файл `libs.html`:

```html
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script> alert('Библиотеки подключены!'); </script>
```

Это можно использовать, чтобы не подгружать одинаковые зависимости много раз. И сама страница и её импорты, и их подимпорты, и так далее, могут подключать `libs.html` без опасения лишний раз перезагрузить и выполнить скрипты.

Например:
<ul>
<li>Главный файл `index.html` подключает документы:

```html
<link rel="import" href="ui-tabs.html">
<link rel="import" href="ui-dialog.html">
...
```

</li>
<li>`ui-tabs.html`:

```html
<link rel="import" href="libs.html">
...template и код для табов...
```

</li>

<li>`ui-dialog.html`:

```html
<link rel="import" href="libs.html">
...template и код для диалогов...
```

</li>
</ul>

[edit src="import-libs"/]

Открыв пример, вы увидите, что скрипты `libs.html` сработают один раз.

## Итого

Тег `<link rel="import">` позволяет подключить любой документ к странице, причём:

<ul>
<li>Скриптовое пространство и стили со страницей будут общие.</li>
<li>Документ DOM -- отдельный, он доступен как `link.import` снаружи, а из внутреннего скрипта -- через `document.currentScript.ownerDocument`. Можно без проблем переносить элементы из главного документа в импорт и наоборот.</li>
<li>Импорты могут содержать другие импорты.</li>
<li>Если какой-то URL импортируется повторно -- подключается уже готовый документ, без повторного выполнения скриптов в нём. Это можно использовать для удобного управления зависимостями.</li>
</ul>
 
