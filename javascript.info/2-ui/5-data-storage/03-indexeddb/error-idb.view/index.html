<!doctype html>
<script src="https://cdn.jsdelivr.net/npm/idb@3.0.2/build/idb.min.js"></script>
<script>
window.addEventListener('unhandledrejection', event => {
  console.dir("REJECT", event); // IndexedDB native request object

  console.log("REJECT", event.reason); // Error: Whoops! - the unhandled error object
  // also accessible as event.promise.request.error
});


(async () => {
  await run();
})();

async function run() {
  var db = await idb.openDb('test_db', 1, function(db) {
    if (!db.objectStoreNames.contains('store')) {
      var storeOS = db.createObjectStore('store', {keyPath: 'name'});
    }
  });

  var transaction = db.transaction(['store'], 'readwrite');
  var store = transaction.objectStore('store');
  var item = {
    name: 'bananass',
    price: '$2.99',
    description: 'It is a purple banana!',
    created: new Date().getTime()
  };

  var promise = store.add(item);
  var request = promise.request;

  request.addEventListener('error', function(e) {
    console.log('REQ error', e);
  });

  request.addEventListener('success', function(e) {
    console.log('Woot! Did it');
  });

  transaction._tx.addEventListener('error', e => console.log("TX ERR", e));
  db._db.addEventListener('error', e => console.log("DB ERR", e));
  window.onerror = e => console.log("WINDOW ERR", e);

  try {
    await promise;
  } catch(e) {
    console.log("CAUGHT", e)
  }

await transaction.complete;
console.log("COMPLETE")

}


</script>
